# Chart Architecture

## Обзор

График погоды реализован с использованием Canvas API для отрисовки данных погоды. Архитектура разделена на компонент Svelte и утилитарные функции с централизованными константами.

## Структура

### Widget Layer
```
src/widgets/weather-chart/
├── Chart.svelte          # Основной компонент графика
├── chartUtils.ts         # Утилитарные функции для отрисовки
└── index.ts             # Экспорты
```

### Shared Layer
```
src/shared/lib/batch-renderer/
├── BatchRenderer.ts      # Batch рендеринг графиков
└── index.ts             # Экспорты
```

### Зависимости
- **Shared Layer**: `@shared/constants` - константы конфигурации
- **Shared Layer**: `@shared/types` - типы данных
- **Shared Layer**: `@shared/lib/batch-renderer` - BatchRenderer для отрисовки
- **Entities Layer**: `@entities/weather-data` - управление данными

## Компонент Chart.svelte

### Props
- `data: WeatherDataPoint[]` - данные для отрисовки
- `startYear: number` - начальный год
- `endYear: number` - конечный год  
- `dataType: 'temperature' | 'precipitation'` - тип данных

### Логика компонента

#### onMount()
**Работа**: Инициализация Canvas при монтировании компонента
**Для чего**: Установка размеров canvas и подготовка к отрисовке
**Как работает**:
- Устанавливает флаг готовности canvas
- Задает размеры canvas из констант CHART_CONFIG.CANVAS_WIDTH/HEIGHT
- Вызывает отрисовку если данные уже загружены

#### drawChart()
**Работа**: Основная функция отрисовки всех элементов графика
**Для чего**: Полная перерисовка графика с новыми данными
**Как работает**:
- Получает 2D контекст canvas
- Настраивает HiDPI масштабирование через devicePixelRatio
- Очищает весь canvas от предыдущих данных
- Рассчитывает рабочую область через getChartDimensions()
- Фильтрует данные по годам через filterDataByYearRange()
- Применяет даунсэмплинг через downsampleData() для производительности
- Рассчитывает диапазон значений через calculateValueRange()
- Выполняет все этапы отрисовки по порядку

#### onMount()
**Работа**: Инициализация BatchRenderer при монтировании компонента
**Для чего**: Создание экземпляра BatchRenderer и подготовка к отрисовке
**Как работает**:
- Создает экземпляр BatchRenderer
- Устанавливает флаг готовности canvas
- Вызывает отрисовку если данные уже загружены

#### drawChart()
**Работа**: Основная функция подготовки данных и запуска batch рендеринга
**Для чего**: Подготовка контекста рендеринга и запуск BatchRenderer
**Как работает**:
- Получает 2D контекст canvas
- Настраивает HiDPI масштабирование через devicePixelRatio
- Рассчитывает рабочую область через getChartDimensions()
- Фильтрует данные по годам через filterDataByYearRange()
- Применяет даунсэмплинг через downsampleData() для производительности
- Рассчитывает диапазон значений через calculateValueRange()
- Создает RenderContext и передает в BatchRenderer.render()

#### scheduleRender()
**Работа**: Планирование отрисовки через requestAnimationFrame
**Для чего**: Оптимизация производительности и предотвращение блокировки UI
**Как работает**:
- Отменяет предыдущий запрос отрисовки если есть
- Использует requestAnimationFrame для синхронизации с браузером
- Вызывает drawChart() в следующем кадре анимации

### Реактивность
**Работа**: Автоматическое обновление при изменении данных
**Для чего**: Синхронизация графика с состоянием приложения
**Как работает**:
- Svelte $effect отслеживает изменения data, startYear, endYear, dataType
- При изменении автоматически вызывается scheduleRender()
- Обеспечивает актуальность отображаемых данных

## BatchRenderer (shared/lib/batch-renderer/BatchRenderer.ts)

### Назначение
BatchRenderer обеспечивает плавную отрисовку больших графиков без блокировки UI через разбиение процесса на батчи.

### Основные методы

#### render()
**Работа**: Основной метод batch рендеринга графика
**Для чего**: Плавная отрисовка без блокировки интерфейса
**Как работает**:
- Разбивает данные на батчи по 100 точек
- Очищает canvas через clearCanvas()
- Рисует элементы поэтапно: сетка, оси, линия, точки, подписи
- Использует requestAnimationFrame для каждого батча
- Поддерживает отмену рендеринга через cancel()

#### clearCanvas()
**Работа**: Очистка canvas с учетом device pixel ratio
**Для чего**: Подготовка к новой отрисовке
**Как работает**:
- Рассчитывает логические размеры с учетом DPR
- Очищает canvas через clearRect()
- Заполняет фон цветом из CHART_COLORS.BACKGROUND

#### cancel()
**Работа**: Отмена текущего процесса рендеринга
**Для чего**: Предотвращение конфликтов при быстрых изменениях данных
**Как работает**:
- Увеличивает счетчик currentRenderId
- Устанавливает флаг isRendering = false
- Отменяет текущий requestAnimationFrame

### Интерфейс RenderContext
```typescript
interface RenderContext {
    ctx: CanvasRenderingContext2D;
    margin: number;
    plotWidth: number;
    plotHeight: number;
    minValue: number;
    valueRange: number;
    dataType: 'temperature' | 'precipitation';
    t0: number;
    t1: number;
}
```

## Утилитарные функции (chartUtils.ts)

### Интерфейсы и типы

#### ChartDimensions
```typescript
interface ChartDimensions {
    margin: number;
    plotWidth: number;
    plotHeight: number;
}
```
**Работа**: Определяет размеры рабочей области графика
**Для чего**: Централизованное управление размерами

#### ValueRange
```typescript
interface ValueRange {
    minValue: number;
    maxValue: number;
    valueRange: number;
    step: number;
}
```
**Работа**: Определяет диапазон значений данных с шагом
**Для чего**: Нормализация данных для отображения и расчета подписей оси Y

### Функции расчета размеров

#### getChartDimensions()
**Работа**: Расчет размеров рабочей области графика
**Для чего**: Определение области отрисовки с учетом отступов
**Как работает**:
- Принимает ширину и высоту canvas
- Добавляет дополнительный отступ слева (LEFT_MARGIN_BOOST) для подписей Y
- Вычитает отступы с каждой стороны
- Возвращает объект с margin, plotWidth, plotHeight

### Функции обработки данных

#### filterDataByYearRange()
**Работа**: Фильтрация данных по временному диапазону
**Для чего**: Отбор точек данных за выбранные годы
**Как работает**:
- Проходит по массиву точек данных
- Извлекает год из ISO даты через new Date()
- Сравнивает год с startYear и endYear
- Сортирует результат по времени для корректного отображения
- Возвращает только подходящие точки

#### calculateValueRange()
**Работа**: Расчет диапазона значений для нормализации с "красивыми" пределами
**Для чего**: Преобразование реальных значений в координаты canvas с оптимальными подписями
**Как работает**:
- Находит минимальное и максимальное значения в данных
- Применяет алгоритм "красивых" пределов через calculateNiceLimits()
- Добавляет отступы сверху и снизу (5% от диапазона)
- Для осадков ограничивает минимальное значение нулем
- Рассчитывает оптимальный шаг для подписей оси Y
- Возвращает объект с minValue, maxValue, valueRange, step

### Функции даунсэмплинга

#### downsampleData()
**Работа**: Уменьшение количества точек данных для производительности
**Для чего**: Оптимизация отрисовки при большом количестве данных
**Как работает**:
- Применяет алгоритм LTTB (Largest-Triangle-Three-Buckets)
- Сохраняет важные точки (пики, впадины, начало/конец)
- Уменьшает количество точек до DEFAULT_DOWNSAMPLE_POINTS (1000)
- Возвращает оптимизированный массив точек

### Функции расчета координат

#### calculateXByTime()
**Работа**: Расчет X координаты на основе времени
**Для чего**: Точное позиционирование точек по временной шкале
**Как работает**:
- Принимает время точки, начальное и конечное время
- Вычисляет прогресс времени (0-1)
- Умножает на ширину рабочей области
- Добавляет отступ слева

#### calculateYCoordinate()
**Работа**: Расчет Y координаты для точки данных
**Для чего**: Преобразование значения в вертикальную позицию
**Как работает**:
- Нормализует значение относительно диапазона (0-1)
- Умножает на высоту рабочей области
- Инвертирует координату (canvas Y растет вниз)
- Добавляет отступ сверху

### Функции отрисовки

#### drawGrid()
**Работа**: Создание координатной сетки из линий
**Для чего**: Визуальное разделение области графика на секторы
**Как работает**:
- Устанавливает цвет линий (#e0e0e0) и толщину (1px)
- Рисует 11 вертикальных линий через равные интервалы по X
- Рисует 11 горизонтальных линий через равные интервалы по Y
- Использует beginPath(), moveTo(), lineTo(), stroke() для каждой линии

#### drawChartLine()
**Работа**: Соединение точек данных непрерывной линией
**Для чего**: Визуализация тренда изменения данных
**Как работает**:
- Выбирает цвет в зависимости от типа данных из CHART_COLORS
- Устанавливает толщину линии из CHART_CONFIG.LINE_WIDTH
- Настраивает сглаживание линий (lineJoin, lineCap)
- Начинает новый путь с beginPath()
- Для каждой точки рассчитывает координаты через calculateXByTime() и calculateYCoordinate()
- Использует moveTo() для первой точки, lineTo() для остальных
- Завершает отрисовку stroke()

#### drawDataPoints()
**Работа**: Отображение отдельных точек измерений
**Для чего**: Показ точных значений измерений
**Как работает**:
- Устанавливает цвет заливки из CHART_COLORS по типу данных
- Для каждой точки рассчитывает координаты через calculateXByTime() и calculateYCoordinate()
- Рисует круг радиусом CHART_CONFIG.POINT_RADIUS через arc()
- Заполняет круг через fill()

#### drawAxes()
**Работа**: Создание основных координатных осей
**Для чего**: Определение системы координат графика
**Как работает**:
- Устанавливает цвет (#333) и толщину (2px)
- Рисует горизонтальную ось X снизу графика
- Рисует вертикальную ось Y слева графика
- Использует beginPath(), moveTo(), lineTo(), stroke()

#### drawYAxisLabels()
**Работа**: Отображение числовых значений по вертикальной оси
**Для чего**: Позволяет читать точные значения на графике
**Как работает**:
- Устанавливает шрифт и цвет из CHART_CONFIG и CHART_COLORS
- Выравнивает текст по правому краю и центру по вертикали
- Использует шаг из calculateValueRange() для равномерного распределения
- Для каждого значения рассчитывает Y координату
- Форматирует числа с одним знаком после запятой
- Рисует текст через fillText()

#### drawXAxisLabels()
**Работа**: Отображение временных меток по горизонтальной оси
**Для чего**: Показ временного контекста данных
**Как работает**:
- Использует buildSmartDateLabels() для расчета оптимальных меток
- Устанавливает шрифт и цвет из CHART_CONFIG и CHART_COLORS
- Выравнивает текст по центру и верху
- Применяет алгоритм предотвращения наложения меток
- Проверяет минимальный отступ между метками (MIN_GAP_BETWEEN_LABELS)
- Ограничивает метки границами рабочей области (PLOT_BOUNDARY_OFFSET)
- Для первой и последней метки использует специальное выравнивание
- Рисует только те метки, которые не накладываются на предыдущие

#### buildSmartDateLabels()
**Работа**: Расчет оптимальных временных меток для оси X
**Для чего**: Интеллектуальное отображение дат без наложения
**Как работает**:
- Анализирует временной диапазон данных
- Выбирает подходящий формат (дни/месяцы/годы) в зависимости от периода
- Рассчитывает оптимальный шаг между метками
- Ограничивает количество меток до MAX_X_LABELS (10)
- Использует calculateXByTime() для точного позиционирования
- Возвращает массив меток с информацией о позиции и типе выравнивания

#### drawAxisTitles()
**Работа**: Добавление названий осей
**Для чего**: Объяснение что показывают оси
**Как работает**:
- Устанавливает шрифт и цвет из CHART_CONFIG и CHART_COLORS
- Рисует "Года" по центру под осью X с отступом X_TITLE_FROM_BOTTOM
- Для оси Y использует save(), translate(), rotate() для поворота текста
- Рисует "Температура (°C)" или "Осадки (мм)" в зависимости от типа данных
- Восстанавливает контекст через restore()

## Конфигурация

### Централизованные константы (CHART_CONFIG)

#### Размеры Canvas
- `CANVAS_WIDTH: 1200px` - ширина canvas
- `CANVAS_HEIGHT: 600px` - высота canvas
- `CANVAS_MARGIN: 50px` - базовый отступ
- `LEFT_MARGIN_BOOST: 34px` - дополнительный отступ слева для подписей Y
- `X_TITLE_FROM_BOTTOM: 24px` - отступ заголовка "Года" от низа

#### Визуальные параметры
- `GRID_LINES_COUNT: 10` - количество линий сетки
- `LINE_WIDTH: 2px` - толщина линии графика
- `POINT_RADIUS: 3px` - радиус точек данных
- `AXIS_LINE_WIDTH: 2px` - толщина осей
- `GRID_LINE_WIDTH: 1px` - толщина линий сетки

#### Типографика
- `FONT_SIZE: 12px` - размер шрифта подписей
- `FONT_FAMILY: 'Arial'` - семейство шрифтов
- `TITLE_FONT_SIZE: 14px` - размер шрифта заголовков
- `TEXT_OFFSET_X: 10px` - отступ текста по X
- `TEXT_OFFSET_Y: 4px` - отступ текста по Y

#### Позиционирование
- `X_AXIS_LABEL_OFFSET: 20px` - отступ меток оси X
- `AXIS_TITLE_OFFSET: 10px` - отступ заголовков осей
- `AXIS_TITLE_ROTATION: -Math.PI / 2` - поворот заголовка оси Y
- `AXIS_TITLE_TRANSLATE_X: 15px` - смещение заголовка оси Y

#### Алгоритмы
- `Y_AXIS_LABELS_COUNT: 5` - количество подписей оси Y
- `Y_AXIS_PADDING_PERCENT: 0.05` - отступы сверху/снизу (5%)
- `MAX_X_LABELS: 10` - максимальное количество меток оси X
- `DEFAULT_DOWNSAMPLE_POINTS: 1000` - количество точек для даунсэмплинга

#### Временные константы
- `MILLISECONDS_PER_DAY: 1000 * 60 * 60 * 24` - миллисекунды в дне
- `DAYS_PER_YEAR: 365` - дни в году
- `DAYS_PER_MONTH: 30` - дни в месяце

#### Отступы и границы
- `MIN_GAP_BETWEEN_LABELS: 8px` - минимальный отступ между метками
- `PLOT_BOUNDARY_OFFSET: 2px` - отступ границ рабочей области
- `EPSILON: 1e-9` - малое число для избежания деления на ноль

### Цветовая схема (CHART_COLORS)
- `TEMPERATURE: '#ff6b6b'` - цвет линии температуры
- `PRECIPITATION: '#4ecdc4'` - цвет линии осадков
- `GRID: '#e0e0e0'` - цвет линий сетки
- `AXIS: '#333'` - цвет осей
- `TEXT: '#666'` - цвет текста
- `BACKGROUND: '#fff'` - цвет фона

### CSS переменные
```css
--chart-width: 1200px;
--chart-height: 600px;
```

### Файлы конфигурации
- `src/shared/constants.ts` - основные константы
- `src/shared/variables.css` - CSS переменные

## Новые возможности

### HiDPI поддержка
- Автоматическое масштабирование canvas для высоких разрешений
- Использование `devicePixelRatio` для четкого отображения на Retina дисплеях
- Правильная толщина линий и размеры элементов

### Даунсэмплинг данных
- Алгоритм LTTB для сохранения важных точек данных
- Оптимизация производительности при больших объемах данных
- Сохранение визуальной точности графика

### "Красивые" пределы оси Y
- Автоматический расчет оптимальных пределов с отступами
- Интеллектуальный выбор шага для подписей
- Специальная обработка осадков (минимум = 0)

### Умные метки оси X
- Адаптивный формат дат в зависимости от временного диапазона
- Предотвращение наложения меток
- Равномерное распределение по временной шкале

### Централизованная конфигурация
- Все магические числа вынесены в константы
- Легкая настройка внешнего вида через CHART_CONFIG
- CSS переменные для размеров canvas
